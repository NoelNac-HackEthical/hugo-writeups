{{- $page := . -}}

{{/* === Trouver une image dans le bundle : cover.image > thumb* > image* > première image === */}}
{{- $img := (and $page.Params.cover.image ($page.Resources.GetMatch $page.Params.cover.image)) -}}
{{- if not $img }}{{ $img = $page.Resources.GetMatch "thumb*" }}{{ end -}}
{{- if not $img }}{{ $img = $page.Resources.GetMatch "image*" }}{{ end -}}
{{- if not $img -}}
  {{- $imgs := $page.Resources.ByType "image" -}}
  {{- if gt (len $imgs) 0 }}{{ $img = index $imgs 0 }}{{ end -}}
{{- end -}}

{{/* === Générer une miniature 120x120 si on a une image bundle === */}}
{{- $thumb := $img -}}
{{- $thumbWebp := $img -}}
{{- if $img -}}
  {{- $anchor := default "center" $page.Params.cover.anchor -}}
  {{- $fill    := printf "120x120 %s" $anchor -}}
  {{- $fillWeb := printf "120x120 %s webp" $anchor -}}
  {{- $thumb     = $img.Fill $fill -}}
  {{- $thumbWebp = $img.Fill $fillWeb -}}
{{- end -}}

{{/* === Texte ALT : cover.alt prioritaire, sinon "Writeup <Titre>" === */}}
{{- $alt := $page.Params.cover.alt | default (printf "Writeup %s" $page.Title) -}}

{{/* === Texte de recherche pour filtrage JS === */}}
{{- $sum := "" -}}
{{- with $page.Params.summary -}}
  {{- $sum = . -}}
{{- else -}}
  {{- $sum = ($page.Summary | plainify) -}}
{{- end -}}

{{- $tags := "" -}}
{{- with $page.Params.tags -}}
  {{- $tags = delimit . " " -}}
{{- end -}}

{{- $search := printf "%s %s %s %s" $page.Title $page.File.BaseFileName $tags ($sum | truncate 220) -}}

<li class="post-item js-machine-card" data-search="{{ $search | plainify }}">
  <h2 class="post-title">
    {{ if eq $page.Section "writeups" }}
      <a href="{{ $page.RelPermalink | relURL }}" aria-label="Ouvrir {{ $page.Title }}">
        Writeup {{ $page.Title }}
      </a>
    {{ else }}
      <a href="{{ $page.RelPermalink | relURL }}" aria-label="Ouvrir {{ $page.Title }}">
        {{ $page.Title }}
      </a>
    {{ end }}
  </h2>

  <div class="post-meta">
    Publié le {{ $page.Date | time.Format ":date_long" }}
    · modifié le {{ $page.Lastmod | time.Format ":date_long" }}
  </div>

  <div class="summary-image-row">
    <p class="post-summary">
      {{ with $page.Params.summary }}{{ . }}{{ else }}{{ $page.Summary | plainify | truncate 180 }}{{ end }}
    </p>

    {{ if $thumb }}
      <a class="thumb-wrap" href="{{ $page.RelPermalink | relURL }}" aria-label="Ouvrir {{ $page.Title }}">
        <picture>
          {{ with $thumbWebp }}<source srcset="{{ .RelPermalink }}" type="image/webp">{{ end }}
          <img
            src="{{ $thumb.RelPermalink }}"
            alt="{{ $alt }}"
            loading="lazy" decoding="async"
            width="{{ $thumb.Width }}" height="{{ $thumb.Height }}">
        </picture>
      </a>
    {{ else }}
      <a class="thumb-wrap" href="{{ $page.RelPermalink | relURL }}" aria-label="Ouvrir {{ $page.Title }}">
        <img
          src="/images/defaults/image.png"
          alt="{{ $alt }}"
          loading="lazy" decoding="async"
          width="120" height="120">
      </a>
    {{ end }}
  </div>

  {{ with $page.Params.tags }}
  <div class="post-tags">
    {{ range . }}
      <a href="{{ (printf "/tags/%s/" (urlize .)) | relURL }}" class="tag">#{{ . }}</a>
    {{ end }}
  </div>
  {{ end }}
</li>
