{{/* Charge le script de surlignage via Hugo Pipes (minify + SRI) */}}
{{- $hl := resources.Get "js/highlight.js" | resources.Minify | resources.Fingerprint -}}
<script defer src="{{ $hl.RelPermalink }}" integrity="{{ $hl.Data.Integrity }}"></script>

<script>
(function(){
  function placeTOCAndSync(){
    const content = document.querySelector(".post-content");
    if (!content) return;

    // --- TOC Ã  droite (layout 2 colonnes) ---
    const tocId = document.getElementById("TableOfContents");
    const tocWrapper = tocId ? tocId.closest(".toc") : null;
    let toc = tocWrapper || tocId || document.querySelector("aside.toc, details.toc, .toc");
    if (toc){
      let col = content.querySelector(":scope > .content-col");
      if (!col) {
        col = document.createElement("div");
        col.className = "content-col";
        Array.from(content.children).forEach(ch => {
          if (ch === toc || ch.id === "TableOfContents" || ch.classList?.contains("toc")) return;
          col.appendChild(ch);
        });
        content.innerHTML = "";
        content.appendChild(col);
        content.appendChild(toc);
      } else if (!content.contains(toc)) {
        content.appendChild(toc);
      }
      // Nettoyage hors .post-content
      document.querySelectorAll("aside.toc, details.toc, .toc, #TableOfContents").forEach(el => {
        if (!content.contains(el)) { try { el.remove(); } catch(e){} }
      });
      document.querySelectorAll("summary, .toc-title, h1,h2,h3,h4,h5,h6").forEach(el => {
        const t = (el.textContent||"").trim().toLowerCase();
        if (/^sommaire$|^table of contents$|^contents$/.test(t) && !content.contains(el)) {
          try { el.remove(); } catch(e){}
        }
      });
    }

    // Activer le layout 2 colonnes
    content.classList.add("toc-ready");

    // Respecter une ancre explicite (#id) en prioritÃ©
    const hash = decodeURIComponent(location.hash || "").replace(/^#/, "");
    if (hash) {
      const target = document.getElementById(hash);
      if (target) {
        target.scrollIntoView({behavior:"instant", block:"start"});
        setTimeout(()=> target.scrollIntoView({behavior:"smooth", block:"start"}), 60);
      }
    }

    // ðŸ‘‰ Notifier les scripts â€œpost-contentâ€ (ex: highlight.js)
    window.dispatchEvent(new Event("postcontent-ready"));

    // Filet : si highlight est prÃ©sent, recentrer lÃ©gÃ¨rement aprÃ¨s peinture
    const params = new URLSearchParams(location.search);
    if (params.has('highlight')) {
      setTimeout(()=>{
        if (window.__HL && window.__HL.booted && window.__HL.booted()){
          const current = document.querySelector('mark.__hl-target') || document.querySelector('mark.__hl');
          if (current) current.scrollIntoView({behavior:"smooth", block:"center"});
        } else if (window.__HL && window.__HL.init){
          window.__HL.init();
        }
      }, 120);
    }

    // 2e chance pour des scripts qui Ã©coutent "hashchange"
    setTimeout(()=> window.dispatchEvent(new Event('hashchange')), 100);
  }

  // Lancer APRÃˆS chargement complet
  window.addEventListener('load', placeTOCAndSync);
  // Retour depuis le cache dâ€™historique
  window.addEventListener('pageshow', (ev)=> { if (ev.persisted) placeTOCAndSync(); });
})();
</script>
