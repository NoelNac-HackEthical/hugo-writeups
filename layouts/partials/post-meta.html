{{/* layouts/partials/post-meta.html — robuste sections / pages
   - Section :
       1) si enfants valides -> max(.Lastmod) des enfants
       2) sinon -> GitInfo.AuthorDate du _index.md
       3) sinon -> .Lastmod du _index.md
       4) sinon -> .File.ModTime du _index.md
   - Page normale : .Lastmod
*/}}

<ul class="post-meta meta-block">

  {{/* ---- Publication ---- */}}
  {{ with .PublishDate }}
    <li>&#128197;
      {{ i18n "publishDate" (dict "Format" (. | time.Format "2 January 2006")) }}
    </li>
  {{ end }}

  {{/* ---- Dernière mise à jour ---- */}}
  {{- $now := now -}}
  {{- $last := .Lastmod -}}

  {{/* Récupérer la page de section si besoin */}}
  {{- $sectionPage := . -}}
  {{- if ne .Kind "section" -}}
    {{- if ne .Section "" -}}
      {{- with site.GetPage (printf "/%s" .Section) -}}
        {{- $sectionPage = . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if eq $sectionPage.Kind "section" -}}
    {{/* 1) enfants non draft/non futurs */}}
    {{- $pages := $sectionPage.RegularPagesRecursive -}}
    {{- $pages = where $pages "Draft" false -}}
    {{- $pages = where $pages "PublishDate" "le" $now -}}
    {{- if gt (len $pages) 0 -}}
      {{- $last = (index ($pages.ByLastmod.Reverse) 0).Lastmod -}}
    {{- else -}}
      {{/* 2) GitInfo de _index.md si dispo */}}
      {{- with $sectionPage.GitInfo -}}
        {{- $last = .AuthorDate -}}
      {{- else -}}
        {{/* 3) .Lastmod de _index.md si non vide, sinon 4) ModTime fichier */}}
        {{- if not $sectionPage.Lastmod.IsZero -}}
          {{- $last = $sectionPage.Lastmod -}}
        {{- else -}}
          {{- with $sectionPage.File -}}
            {{- $last = .ModTime -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{ with $last }}
    <li>&#128197;
      {{ i18n "lastUpdated" (dict "Format" (. | time.Format "2 January 2006")) }}
    </li>
  {{ end }}

  {{/* ---- Lecture ---- */}}
  {{ $showRT := site.Params.ShowReadingTime | default false }}
  {{ $hideRT := or (.Params.hideReadingTime) (eq .Section "outils") }}
  {{ if and $showRT (not $hideRT) }}
    {{ with .ReadingTime }}
      <li>&#9201;
        {{ i18n "readingTime" (dict "Count" .) }}
      </li>
    {{ end }}
  {{ end }}

</ul>
