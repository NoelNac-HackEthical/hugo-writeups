{{ define "main" }}
<main class="main">
  <article class="post-single">
    <header class="post-header">

  {{/* Image d'entête pour les writeups : image.png dans le bundle, sinon image par défaut */}}
  {{ if eq .Section "writeups" }}

    {{/* ALT de l'image : priorité à cover.alt, sinon fallback Title */}}
    {{ $alt := .Params.cover.alt | default .Title }}

    {{/* Image locale du bundle si présente */}}
    {{ $raw := .Resources.GetMatch "image.png" }}

    {{ if $raw }}
        {{/* Redimensionnement 256x256 */}}
        {{ $img := $raw.Fit "256x256" }}
        <div class="writeup-cover">
          <img src="{{ $img.RelPermalink }}" alt="{{ $alt }}" loading="lazy" width="256" height="256" />
        </div>

    {{ else }}
        {{/* Fallback sécurisé (assets → static) */}}
        {{ $defaultRaw := resources.Get "images/image.png" }}
        {{ if $defaultRaw }}
          {{ $defaultImg := $defaultRaw.Fit "256x256" }}
          <div class="writeup-cover">
            <img src="{{ $defaultImg.RelPermalink }}" alt="{{ $alt }}" loading="lazy" width="256" height="256" />
          </div>
        {{ else }}
          <div class="writeup-cover">
            <img src="/images/image.png" alt="{{ $alt }}" loading="lazy" width="256" height="256" />
          </div>
        {{ end }}
    {{ end }}

  {{ end }}


      {{ if eq .Section "writeups" }}
        <h1>{{ .Title }}</h1>
      {{ else }}
        <h1>{{ .Title }}</h1>
      {{ end }}

      {{ partial "post-meta.html" . }}

      {{ if eq .Section "writeups" }}
        {{ partial "tagsline.html" . }}
      {{ end }}
      
    </header>

    {{/* TOC visible partout sauf dans la section "mes-scripts" */}}
    {{ $toc := .TableOfContents }}
    {{ $showToc := and (ne .Section "mes-scripts") (ne $toc "") }}

    <div class="post-content {{ if $showToc }}has-toc{{ end }}">
      {{ if $showToc }}
        {{ $toc }}
      {{ end }}

      {{/* Prépare le contenu et, pour mes-scripts, enlève un éventuel 1er paragraphe = description */}}
      {{ $content := .Content }}
      {{ $isScripts := eq .Section "mes-scripts" }}
      {{ if and $isScripts .Params.description }}
        {{ $firstPArr := findRE `(?s)^\s*<p>.*?</p>` $content 1 }}
        {{ if gt (len $firstPArr) 0 }}
          {{ $firstP := index $firstPArr 0 }}
          {{ $firstPlain := $firstP | replaceRE `(?is)</?p>` "" | plainify | lower | trim " \n\r\t" }}
          {{ $descPlain  := .Params.description | plainify | lower | trim " \n\r\t" }}
          {{ if eq $firstPlain $descPlain }}
            {{ $content = replaceRE `(?s)^\s*<p>.*?</p>\s*` "" $content }}
          {{ end }}
        {{ end }}
      {{ end }}

      <!-- Colonne principale -->
      <div class="post-article {{ if or (eq .Section "writeups") $isScripts }}no-cols{{ end }}">

        {{/* Boîte description centrée (mes-scripts uniquement), au-dessus du 1er H2 */}}
        {{ if and $isScripts .Params.description }}
          <div class="script-desc-box" role="note">
            {{ .Params.description }}
          </div>
        {{ end }}

        {{ $content | safeHTML }}
      </div>
    </div>

    <!-- Navigation bas de page (précédent / suivant dans la même section) -->
    <footer class="post-footer">
      <nav class="post-nav">
        {{ with .PrevInSection }}
          <a class="prev" href="{{ .RelPermalink }}" rel="prev" title="{{ .Title }}">← {{ .Title }}</a>
        {{ end }}
        {{ with .NextInSection }}
          <a class="next" href="{{ .RelPermalink }}" rel="next" title="{{ .Title }}">{{ .Title }} →</a>
        {{ end }}
      </nav>
    </footer>
  </article>
</main>
{{ end }}
